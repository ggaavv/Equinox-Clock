/******************************************************************************
 * This function converts HSV values to RGB values, scaled from 0 to maxBrightness
 * 
 * The ranges for the input variables are:
 * hue: 0-360
 * sat: 0-255
 * lig: 0-255
 * 
 * The ranges for the output variables are:
 * r: 0-maxBrightness
 * g: 0-maxBrightness
 * b: 0-maxBrightness
 * 
 * r,g, and b are passed as pointers, because a function cannot have 3 return variables
 * Use it like this:
 * int hue, sat, val; 
 * unsigned char red, green, blue;
 * // set hue, sat and val
 * hsv2rgb(hue, sat, val, &red, &green, &blue, maxBrightness); //pass r, g, and b as the location where the result should be stored
 * // use r, b and g.
 * 
 * (c) Elco Jacobs, E-atelier Industrial Design TU/e, July 2011.
 * 
 *****************************************************************************/

#include "hsv2rgb.h"
#include "comm.h"

#define Vs 5 // Voltage
#define RED_Vf 2
#define GREEN_Vf 3.4
#define BLUE_Vf 3.4

//		Vs - Vf
// R = ---------
//		  If
#define RED_REDUCTION 255		// (255/Vs)*(Vs-RED_Vf) = 153
#define GREEN_REDUCTION	((RED_REDUCTION/136)*255*3)		// (255/Vs)*(Vs-GREEN_Vf) = 81.6 // (255/153)*81.6 = 136
#define BLUE_REDUCTION ((RED_REDUCTION/136)*255*3)		// (255/Vs)*(Vs-BLUE_Vf) = 81.6

const uint8_t RGB_LOOKUP[360][3] = {
		{	255	,	0	,	0	}	,
		{	255	,	4	,	0	}	,
		{	255	,	9	,	0	}	,
		{	255	,	13	,	0	}	,
		{	255	,	17	,	0	}	,
		{	255	,	21	,	0	}	,
		{	255	,	26	,	0	}	,
		{	255	,	30	,	0	}	,
		{	255	,	34	,	0	}	,
		{	255	,	38	,	0	}	,
		{	255	,	43	,	0	}	,
		{	255	,	47	,	0	}	,
		{	255	,	51	,	0	}	,
		{	255	,	55	,	0	}	,
		{	255	,	60	,	0	}	,
		{	255	,	64	,	0	}	,
		{	255	,	68	,	0	}	,
		{	255	,	72	,	0	}	,
		{	255	,	77	,	0	}	,
		{	255	,	81	,	0	}	,
		{	255	,	85	,	0	}	,
		{	255	,	89	,	0	}	,
		{	255	,	94	,	0	}	,
		{	255	,	98	,	0	}	,
		{	255	,	102	,	0	}	,
		{	255	,	106	,	0	}	,
		{	255	,	111	,	0	}	,
		{	255	,	115	,	0	}	,
		{	255	,	119	,	0	}	,
		{	255	,	123	,	0	}	,
		{	255	,	128	,	0	}	,
		{	255	,	132	,	0	}	,
		{	255	,	136	,	0	}	,
		{	255	,	140	,	0	}	,
		{	255	,	145	,	0	}	,
		{	255	,	149	,	0	}	,
		{	255	,	153	,	0	}	,
		{	255	,	157	,	0	}	,
		{	255	,	162	,	0	}	,
		{	255	,	166	,	0	}	,
		{	255	,	170	,	0	}	,
		{	255	,	174	,	0	}	,
		{	255	,	179	,	0	}	,
		{	255	,	183	,	0	}	,
		{	255	,	187	,	0	}	,
		{	255	,	191	,	0	}	,
		{	255	,	196	,	0	}	,
		{	255	,	200	,	0	}	,
		{	255	,	204	,	0	}	,
		{	255	,	208	,	0	}	,
		{	255	,	213	,	0	}	,
		{	255	,	217	,	0	}	,
		{	255	,	221	,	0	}	,
		{	255	,	225	,	0	}	,
		{	255	,	230	,	0	}	,
		{	255	,	234	,	0	}	,
		{	255	,	238	,	0	}	,
		{	255	,	242	,	0	}	,
		{	255	,	247	,	0	}	,
		{	255	,	251	,	0	}	,
		{	255	,	255	,	0	}	,
		{	251	,	255	,	0	}	,
		{	247	,	255	,	0	}	,
		{	242	,	255	,	0	}	,
		{	238	,	255	,	0	}	,
		{	234	,	255	,	0	}	,
		{	230	,	255	,	0	}	,
		{	225	,	255	,	0	}	,
		{	221	,	255	,	0	}	,
		{	217	,	255	,	0	}	,
		{	213	,	255	,	0	}	,
		{	208	,	255	,	0	}	,
		{	204	,	255	,	0	}	,
		{	200	,	255	,	0	}	,
		{	196	,	255	,	0	}	,
		{	191	,	255	,	0	}	,
		{	187	,	255	,	0	}	,
		{	183	,	255	,	0	}	,
		{	179	,	255	,	0	}	,
		{	174	,	255	,	0	}	,
		{	170	,	255	,	0	}	,
		{	166	,	255	,	0	}	,
		{	162	,	255	,	0	}	,
		{	157	,	255	,	0	}	,
		{	153	,	255	,	0	}	,
		{	149	,	255	,	0	}	,
		{	145	,	255	,	0	}	,
		{	140	,	255	,	0	}	,
		{	136	,	255	,	0	}	,
		{	132	,	255	,	0	}	,
		{	128	,	255	,	0	}	,
		{	123	,	255	,	0	}	,
		{	119	,	255	,	0	}	,
		{	115	,	255	,	0	}	,
		{	111	,	255	,	0	}	,
		{	106	,	255	,	0	}	,
		{	102	,	255	,	0	}	,
		{	98	,	255	,	0	}	,
		{	94	,	255	,	0	}	,
		{	89	,	255	,	0	}	,
		{	85	,	255	,	0	}	,
		{	81	,	255	,	0	}	,
		{	77	,	255	,	0	}	,
		{	72	,	255	,	0	}	,
		{	68	,	255	,	0	}	,
		{	64	,	255	,	0	}	,
		{	60	,	255	,	0	}	,
		{	55	,	255	,	0	}	,
		{	51	,	255	,	0	}	,
		{	47	,	255	,	0	}	,
		{	43	,	255	,	0	}	,
		{	38	,	255	,	0	}	,
		{	34	,	255	,	0	}	,
		{	30	,	255	,	0	}	,
		{	26	,	255	,	0	}	,
		{	21	,	255	,	0	}	,
		{	17	,	255	,	0	}	,
		{	13	,	255	,	0	}	,
		{	9	,	255	,	0	}	,
		{	4	,	255	,	0	}	,
		{	0	,	255	,	0	}	,
		{	0	,	255	,	4	}	,
		{	0	,	255	,	9	}	,
		{	0	,	255	,	13	}	,
		{	0	,	255	,	17	}	,
		{	0	,	255	,	21	}	,
		{	0	,	255	,	26	}	,
		{	0	,	255	,	30	}	,
		{	0	,	255	,	34	}	,
		{	0	,	255	,	38	}	,
		{	0	,	255	,	43	}	,
		{	0	,	255	,	47	}	,
		{	0	,	255	,	51	}	,
		{	0	,	255	,	55	}	,
		{	0	,	255	,	60	}	,
		{	0	,	255	,	64	}	,
		{	0	,	255	,	68	}	,
		{	0	,	255	,	72	}	,
		{	0	,	255	,	77	}	,
		{	0	,	255	,	81	}	,
		{	0	,	255	,	85	}	,
		{	0	,	255	,	89	}	,
		{	0	,	255	,	94	}	,
		{	0	,	255	,	98	}	,
		{	0	,	255	,	102	}	,
		{	0	,	255	,	106	}	,
		{	0	,	255	,	111	}	,
		{	0	,	255	,	115	}	,
		{	0	,	255	,	119	}	,
		{	0	,	255	,	123	}	,
		{	0	,	255	,	128	}	,
		{	0	,	255	,	132	}	,
		{	0	,	255	,	136	}	,
		{	0	,	255	,	140	}	,
		{	0	,	255	,	145	}	,
		{	0	,	255	,	149	}	,
		{	0	,	255	,	153	}	,
		{	0	,	255	,	157	}	,
		{	0	,	255	,	162	}	,
		{	0	,	255	,	166	}	,
		{	0	,	255	,	170	}	,
		{	0	,	255	,	174	}	,
		{	0	,	255	,	179	}	,
		{	0	,	255	,	183	}	,
		{	0	,	255	,	187	}	,
		{	0	,	255	,	191	}	,
		{	0	,	255	,	196	}	,
		{	0	,	255	,	200	}	,
		{	0	,	255	,	204	}	,
		{	0	,	255	,	208	}	,
		{	0	,	255	,	213	}	,
		{	0	,	255	,	217	}	,
		{	0	,	255	,	221	}	,
		{	0	,	255	,	225	}	,
		{	0	,	255	,	230	}	,
		{	0	,	255	,	234	}	,
		{	0	,	255	,	238	}	,
		{	0	,	255	,	242	}	,
		{	0	,	255	,	247	}	,
		{	0	,	255	,	251	}	,
		{	0	,	255	,	255	}	,
		{	0	,	251	,	255	}	,
		{	0	,	247	,	255	}	,
		{	0	,	242	,	255	}	,
		{	0	,	238	,	255	}	,
		{	0	,	234	,	255	}	,
		{	0	,	230	,	255	}	,
		{	0	,	225	,	255	}	,
		{	0	,	221	,	255	}	,
		{	0	,	217	,	255	}	,
		{	0	,	213	,	255	}	,
		{	0	,	208	,	255	}	,
		{	0	,	204	,	255	}	,
		{	0	,	200	,	255	}	,
		{	0	,	196	,	255	}	,
		{	0	,	191	,	255	}	,
		{	0	,	187	,	255	}	,
		{	0	,	183	,	255	}	,
		{	0	,	179	,	255	}	,
		{	0	,	174	,	255	}	,
		{	0	,	170	,	255	}	,
		{	0	,	166	,	255	}	,
		{	0	,	162	,	255	}	,
		{	0	,	157	,	255	}	,
		{	0	,	153	,	255	}	,
		{	0	,	149	,	255	}	,
		{	0	,	145	,	255	}	,
		{	0	,	140	,	255	}	,
		{	0	,	136	,	255	}	,
		{	0	,	132	,	255	}	,
		{	0	,	128	,	255	}	,
		{	0	,	123	,	255	}	,
		{	0	,	119	,	255	}	,
		{	0	,	115	,	255	}	,
		{	0	,	111	,	255	}	,
		{	0	,	106	,	255	}	,
		{	0	,	102	,	255	}	,
		{	0	,	98	,	255	}	,
		{	0	,	94	,	255	}	,
		{	0	,	89	,	255	}	,
		{	0	,	85	,	255	}	,
		{	0	,	81	,	255	}	,
		{	0	,	77	,	255	}	,
		{	0	,	72	,	255	}	,
		{	0	,	68	,	255	}	,
		{	0	,	64	,	255	}	,
		{	0	,	60	,	255	}	,
		{	0	,	55	,	255	}	,
		{	0	,	51	,	255	}	,
		{	0	,	47	,	255	}	,
		{	0	,	43	,	255	}	,
		{	0	,	38	,	255	}	,
		{	0	,	34	,	255	}	,
		{	0	,	30	,	255	}	,
		{	0	,	26	,	255	}	,
		{	0	,	21	,	255	}	,
		{	0	,	17	,	255	}	,
		{	0	,	13	,	255	}	,
		{	0	,	9	,	255	}	,
		{	0	,	4	,	255	}	,
		{	0	,	0	,	255	}	,
		{	4	,	0	,	255	}	,
		{	9	,	0	,	255	}	,
		{	13	,	0	,	255	}	,
		{	17	,	0	,	255	}	,
		{	21	,	0	,	255	}	,
		{	26	,	0	,	255	}	,
		{	30	,	0	,	255	}	,
		{	34	,	0	,	255	}	,
		{	38	,	0	,	255	}	,
		{	43	,	0	,	255	}	,
		{	47	,	0	,	255	}	,
		{	51	,	0	,	255	}	,
		{	55	,	0	,	255	}	,
		{	60	,	0	,	255	}	,
		{	64	,	0	,	255	}	,
		{	68	,	0	,	255	}	,
		{	72	,	0	,	255	}	,
		{	77	,	0	,	255	}	,
		{	81	,	0	,	255	}	,
		{	85	,	0	,	255	}	,
		{	89	,	0	,	255	}	,
		{	94	,	0	,	255	}	,
		{	98	,	0	,	255	}	,
		{	102	,	0	,	255	}	,
		{	106	,	0	,	255	}	,
		{	111	,	0	,	255	}	,
		{	115	,	0	,	255	}	,
		{	119	,	0	,	255	}	,
		{	123	,	0	,	255	}	,
		{	128	,	0	,	255	}	,
		{	132	,	0	,	255	}	,
		{	136	,	0	,	255	}	,
		{	140	,	0	,	255	}	,
		{	145	,	0	,	255	}	,
		{	149	,	0	,	255	}	,
		{	153	,	0	,	255	}	,
		{	157	,	0	,	255	}	,
		{	162	,	0	,	255	}	,
		{	166	,	0	,	255	}	,
		{	170	,	0	,	255	}	,
		{	174	,	0	,	255	}	,
		{	179	,	0	,	255	}	,
		{	183	,	0	,	255	}	,
		{	187	,	0	,	255	}	,
		{	191	,	0	,	255	}	,
		{	196	,	0	,	255	}	,
		{	200	,	0	,	255	}	,
		{	204	,	0	,	255	}	,
		{	208	,	0	,	255	}	,
		{	213	,	0	,	255	}	,
		{	217	,	0	,	255	}	,
		{	221	,	0	,	255	}	,
		{	225	,	0	,	255	}	,
		{	230	,	0	,	255	}	,
		{	234	,	0	,	255	}	,
		{	238	,	0	,	255	}	,
		{	242	,	0	,	255	}	,
		{	247	,	0	,	255	}	,
		{	251	,	0	,	255	}	,
		{	255	,	0	,	255	}	,
		{	255	,	0	,	251	}	,
		{	255	,	0	,	247	}	,
		{	255	,	0	,	242	}	,
		{	255	,	0	,	238	}	,
		{	255	,	0	,	234	}	,
		{	255	,	0	,	230	}	,
		{	255	,	0	,	225	}	,
		{	255	,	0	,	221	}	,
		{	255	,	0	,	217	}	,
		{	255	,	0	,	213	}	,
		{	255	,	0	,	208	}	,
		{	255	,	0	,	204	}	,
		{	255	,	0	,	200	}	,
		{	255	,	0	,	196	}	,
		{	255	,	0	,	191	}	,
		{	255	,	0	,	187	}	,
		{	255	,	0	,	183	}	,
		{	255	,	0	,	179	}	,
		{	255	,	0	,	174	}	,
		{	255	,	0	,	170	}	,
		{	255	,	0	,	166	}	,
		{	255	,	0	,	162	}	,
		{	255	,	0	,	157	}	,
		{	255	,	0	,	153	}	,
		{	255	,	0	,	149	}	,
		{	255	,	0	,	145	}	,
		{	255	,	0	,	140	}	,
		{	255	,	0	,	136	}	,
		{	255	,	0	,	132	}	,
		{	255	,	0	,	128	}	,
		{	255	,	0	,	123	}	,
		{	255	,	0	,	119	}	,
		{	255	,	0	,	115	}	,
		{	255	,	0	,	111	}	,
		{	255	,	0	,	106	}	,
		{	255	,	0	,	102	}	,
		{	255	,	0	,	98	}	,
		{	255	,	0	,	94	}	,
		{	255	,	0	,	89	}	,
		{	255	,	0	,	85	}	,
		{	255	,	0	,	81	}	,
		{	255	,	0	,	77	}	,
		{	255	,	0	,	72	}	,
		{	255	,	0	,	68	}	,
		{	255	,	0	,	64	}	,
		{	255	,	0	,	60	}	,
		{	255	,	0	,	55	}	,
		{	255	,	0	,	51	}	,
		{	255	,	0	,	47	}	,
		{	255	,	0	,	43	}	,
		{	255	,	0	,	38	}	,
		{	255	,	0	,	34	}	,
		{	255	,	0	,	30	}	,
		{	255	,	0	,	26	}	,
		{	255	,	0	,	21	}	,
		{	255	,	0	,	17	}	,
		{	255	,	0	,	13	}	,
		{	255	,	0	,	9	}	,
		{	255	,	0	,	4	}
};


void hsv2rgb(unsigned int hue, unsigned int sat, unsigned int val, \
              unsigned char * r, unsigned char * g, unsigned char * b, unsigned char maxBrightness ) { 
  unsigned int H_accent = hue/60;
  unsigned int bottom = ((255 - sat) * val)>>8;
  unsigned int top = val;
  unsigned char rising  = ((top-bottom)  *(hue%60   )  )  /  60  +  bottom;
  unsigned char falling = ((top-bottom)  *(60-hue%60)  )  /  60  +  bottom;

  switch(H_accent) {
  case 0:
    *r = top;
    *g = rising;
    *b = bottom;
    break;

  case 1:
    *r = falling;
    *g = top;
    *b = bottom;
    break;

  case 2:
    *r = bottom;
    *g = top;
    *b = rising;
    break;

  case 3:
    *r = bottom;
    *g = falling;
    *b = top;
    break;

  case 4:
    *r = rising;
    *g = bottom;
    *b = top;
    break;

  case 5:
    *r = top;
    *g = bottom;
    *b = falling;
    break;
  }
  // Scale values to maxBrightness
  *r = *r * maxBrightness/255;
  *g = *g * maxBrightness/255;
  *b = *b * maxBrightness/255;
// xprintf(INFO "h=%d s=%d v=%d r=%d g=%d b=%d" " (%s:%d)\n", hue, sat, val, *r, *g, *b,_F_,_L_);
}

void lookup_hsv2rgb(unsigned int hue, unsigned char * r, unsigned char * g, unsigned char * b, unsigned char maxBrightness ){
	// Sat and Val both assumed to be 255
	// Scale values to maxBrightness
	*r = RGB_LOOKUP[hue][0] * maxBrightness/RED_REDUCTION;
	*g = RGB_LOOKUP[hue][1] * maxBrightness/GREEN_REDUCTION;
	*b = RGB_LOOKUP[hue][2] * maxBrightness/BLUE_REDUCTION;
}

